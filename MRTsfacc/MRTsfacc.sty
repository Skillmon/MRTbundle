\newcommand*\MRTsfacc@version{0.0.4}
\newcommand*\MRTsfacc@date{2018-11-07}

\NeedsTeXFormat{LaTeX2e}

\ProvidesPackage{MRTsfacc}
  [%
    \MRTsfacc@date\space v\MRTsfacc@version\space fixes accents for sf-math with
    helvet and other fonts%
  ]

\RequirePackage{MRTif}
\RequirePackage{amsmath}

\long\def\MRTsfacc@fifiATa#1\fi\fi#2#3#4{\fi#2}
\long\def\MRTsfacc@fifiBATb#1\fi\fi#2#3#4{\fi\fi#3}
\long\def\MRTsfacc@fifiBBTc\fi\fi#1#2#3{\fi\fi#3}

%% Package options >>>
\def\MRTsfacc@share{0.25}
\newcommand\MRTsfaccSet[1]%>>>
  {%
    \MRTifFloatTF{#1}
      {\def\MRTsfacc@share{#1}}
      {%
        \PackageError{MRTsfacc}{Provided option `#1` is no valid float}
          {%
            Parsing says you didn't provide a valid float. Please provide a
            valid float.\MessageBreak
            If you're sure that you entered a valid float, please report the bug
            to the\MessageBreak
            package maintainer.%
          }%
      }%
  }%<<<
\newif\if@MRTsfacc@notest@
\newif\if@MRTsfacc@height@
\@MRTsfacc@height@true
\DeclareOption{height}{\@MRTsfacc@height@true}
\DeclareOption{list}{\@MRTsfacc@height@false}
\DeclareOption{notest}{\@MRTsfacc@notest@true}
\DeclareOption*{\expandafter\MRTsfaccSet\expandafter{\CurrentOption}}
\ProcessOptions\relax
% <<<

%% Test whether \mathaccentV has the correct meaning >>>
\if@MRTsfacc@notest@
\else
  % this is amsmath's definition of \mathaccentV (2018-06-11)
  \AtBeginDocument% >>>
    {%
      \begingroup
      \newcommand*\MRTsfacc@mathaccentV@test[5]% >>>
        {%
          \ifmmode
            \gdef\macc@tmp{\macc@depth\@ne}%
            \setbox\z@\hbox
              {%
                \let\mathaccentV\macc@test
                \let\use@mathgroup\@gobbletwo
                \let\select@group\@gobblethree
                \frozen@everymath{}%
                $#5$%
              }%
            \macc@tmp
            \ifnum\macc@depth=\@ne
              \global\let\macc@nucleus\@empty
              \mathaccent"\accentclass@
            \else
              \@xp\macc@nested
            \fi
            #2#3#4{#5}\macc@nucleus
          \else
            \@xp\nonmatherr@\csname #1\endcsname
          \fi
        }% <<<
      \ifx\MRTsfacc@mathaccentV@test\mathaccentV
      \else
        \PackageError{MRTsfacc}{Compatibility with amsmath might be broken}
          {%
            This version of MRTsfacc might be incompatible with your version of
            amsmath.%
            \MessageBreak
            This is tested by comparing the definition of
            \string\mathaccentV\space with a known\MessageBreak definition.%
            \MessageBreak
            Read the manual of this `MRTsfacc`. Afterwards you might contact the
            package\MessageBreak maintainer of this package.%
          }%
      \fi
      \endgroup
    }% <<<
\fi
% <<<

\newcommand\MRTsfacc@mathaccentV[4]% >>>
  {%
    \global\let\macc@nucleus\@empty
    \mathaccent"\accentclass@#1#2#3{#4}\macc@nucleus
  }% <<<

%% Test for nested mathaccentV with known argument >>>
\newif\if@MRTsfacc@found@known@
\edef\MRTsfacc@mathaccentV@detokenized{\detokenize{\mathaccentV}}
\long\def\MRTsfacc@mathaccentV@using@inner#1 #2 #3\endMRTsfacc@arg% >>>
  {%
    \MRTifStringsMatchXXTF{\MRTsfacc@mathaccentV@detokenized}{#2 }
  }% <<<
\newcommand\MRTsfacc@mathaccentV@using[1]% >>>
  {%
    \expandafter\MRTsfacc@mathaccentV@using@inner\meaning#1 . .\endMRTsfacc@arg
  }% <<<
\newcommand\MRTsfacc@testnest[2]% >>>
  {%
    \MRTifTwoTokenTF{#2}
      {%
        \@MRTsfacc@found@known@false
        \setbox\z@\hbox
          {%
            \let\MRTsfacc@testknown#1\relax
            \let\mathaccentV\MRTsfacc@testnest@
            \let\use@mathgroup\@gobbletwo
            \let\select@group\@gobblethree
            \frozen@everymath{}%
            $#2$%
          }%
        \if@MRTsfacc@found@known@
          \MRTif@fiAa
        \else
          \MRTif@fiBb
        \fi
      }
      {\@secondoftwo}%
  }% <<<
\newcommand\MRTsfacc@testnest@[5]% >>>
  {%
    \MRTsfacc@testknown{#5}
      {%
        \gdef\MRTsfacc@known{#5}%
        \global\@MRTsfacc@found@known@true
      }
      {%
        \MRTifTwoTokenTF{#5}
          {%
            \expandafter\MRTsfacc@mathaccentV@using\expandafter{\@firstoftwo#5}%
              {\@firstoftwo}
              {\@secondoftwo}%
          }
          {\@secondoftwo}%
          {#5}
          {\global\@MRTsfacc@found@known@false}%
      }%
  }% <<<
% <<<

%% stupid package for math font is stupid. Have to cure the sickness >>>
\if@MRTsfacc@height@
% true >>>
  \newcommand*\MRTsfacc@patch@mathaccentV% >>>
    {%
      \protected\long\def\mathaccentV##1##2##3##4% >>>
        {%
          \ifmmode
            \def\mathaccentV@args{{##2}{##3}{##4}}%
            \MRTif@fiAy
          \else
            \@xp\nonmatherr@\csname ##1\endcsname
            \MRTif@fiBn
          \fi
          {\futurelet\next\mathaccentV@a}%
        }% <<<
    }% <<<
  \newcommand*\MRTsfacc@kern% >>>
    {%
      \MRTsfacc@share\ht\MRTsfacc@box
    }% <<<
  \newbox\MRTsfacc@box
  \newcommand*\mathaccentV@a[1]% >>>
    {%
      \expandafter\ifx\next!%
        \MRTsfacc@fifiATa
      \else
        \expandafter\ifx\next*%
          \MRTsfacc@fifiBATb
        \else
          \MRTsfacc@fifiBBTc
        \fi
      \fi
      {\expandafter\MRTsfacc@mathaccentV\mathaccentV@args}
      {\expandafter\mathaccentV@shifted\mathaccentV@args}
      {\expandafter\mathaccentV@b\mathaccentV@args{#1}}%
    }% <<<
  \newcommand*\mathaccentV@b[4]% >>>
    {%
      \MRTifLetterGTF{#4}
        {\mathaccentV@shifted{#1}{#2}{#3}{#4}}
        {%
          \MRTsfacc@testnest\MRTifLetterGTF{#4}
            {\mathaccentV@shifted{#1}{#2}{#3}{#4}}
            {\MRTsfacc@mathaccentV{#1}{#2}{#3}{#4}}%
        }%
    }% <<<
  \newcommand*\mathaccentV@shifted[4]% >>>
    {%
      \mathchoice
        {\mathaccentV@shifted@a{display}{#1}{#2}{#3}{#4}}
        {\mathaccentV@shifted@a{text}{#1}{#2}{#3}{#4}}
        {\mathaccentV@shifted@a{script}{#1}{#2}{#3}{#4}}
        {\mathaccentV@shifted@a{scriptscript}{#1}{#2}{#3}{#4}}%
    }% <<<
  \newcommand*\mathaccentV@shifted@a[5]% >>>
    {%
      \setbox\MRTsfacc@box\hbox{$\csname #1style\endcsname#5$}%
      \MRTsfacc@mathaccentV{#2}{#3}{#4}%
        {%
          #5%
          \kern\MRTsfacc@kern
        }%
      \kern-\MRTsfacc@kern
    }% <<<
\else% <<<
% false >>>
  \newcommand*\MRTsfacc@patch@mathaccentV% >>>
    {%
      \protected\def\mathaccentV##1##2##3##4% >>>
        {%
          \ifmmode
            \MRTif@fiAy
          \else
            \@xp\nonmatherr@\csname ##1\endcsname
            \MRTif@fiBn
          \fi
          {%
            \@ifnextchar[%]
              {\mathaccentV@b{##2}{##3}{##4}}
              {\mathaccentV@a{##2}{##3}{##4}}%
          }%
        }% <<<
    }% <<<
  \newcommand*\MRTsfacc@ifknown[1]% >>>
    {%
      \begingroup
      \expandafter\ifx\csname\MRTsfacc@shift{#1}\endcsname\relax
        \endgroup
        \MRTif@fiAb
      \else
        \endgroup
        \MRTif@fiBa
      \fi
    }% <<<
  \newcommand*\MRTsfacc@mathaccentV@shifted@expandhelper[5]% >>>
    {%
      \mathaccentV@shifted{#2}{#3}{#4}
        {\csname\MRTsfacc@shift{#1}\endcsname}{#5}%
    }% <<<
  \newcommand\mathaccentV@a[4]% >>>
    {%
      \MRTsfacc@ifknown{#4}
        {%
          \mathaccentV@shifted{#1}{#2}{#3}
            {\csname\MRTsfacc@shift{#4}\endcsname}{#4}%
        }%
        {%
          \MRTsfacc@testnest\MRTsfacc@ifknown{#4}
            {%
              \expandafter\MRTsfacc@mathaccentV@shifted@expandhelper\expandafter
                {\MRTsfacc@known}{#1}{#2}{#3}{#4}%
            }
            {\MRTsfacc@mathaccentV{#1}{#2}{#3}{#4}}%
        }%
    }% <<<
  \long\def\mathaccentV@b#1#2#3[#4]#5% >>>
    {%
      \MRTsfacc@ifknown{#4}
        {%
          \mathaccentV@shifted{#1}{#2}{#3}
            {\csname\MRTsfacc@shift{#4}\endcsname}{#5}%
        }
        {\mathaccentV@shifted{#1}{#2}{#3}{#4}{#5}}%
    }% <<<
  \newcommand\mathaccentV@shifted[5]% >>>
    {%
      \MRTsfacc@mathaccentV{#1}{#2}{#3}
        {%
          #5%
          \mkern#4\relax
        }
      \mkern-#4\relax
    }% <<<
  \newcommand*\MRTsfacc@shift[1]% >>>
    {%
      MRTsfacc@shift@\detokenize{#1}%
    }% <<<
  \newcommand*\MRTsfaccShift[2]% >>>
    {%
      \expandafter\def\csname \MRTsfacc@shift{#1}\endcsname{#2}%
    }% <<<
  \newcommand*\MRTsfaccShiftLet[2]% >>>
    {%
      \MRTsfacc@ifknown{#2}
        {%
          \expandafter\let\csname\MRTsfacc@shift{#1}\expandafter\endcsname
            \csname\MRTsfacc@shift{#2}\endcsname
        }
        {%
          \PackageError{MRTsfacc}{No shift defined for `\detokenize{#2}`.}
            {%
              You have to use an already defined shift as second argument for
              \string\MRTsfaccShiftLet.
            }%
        }%
    }% <<<
  \newcommand*\MRTsfaccLoadShiftList[1]% >>>
    {%
      \input{MRTsfacc.list.#1.tex}%
    }% <<<
% <<<
\fi
% <<<

\AtBeginDocument{\MRTsfacc@patch@mathaccentV}


\endinput
